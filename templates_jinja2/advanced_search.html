{% extends "base.html" %}

{% block title %}Advanced Search - The Blue Alliance{% endblock %}

{% block meta_description %}Search for teams and events using powerful filters{% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-xs-12">
      <h1>Advanced Search</h1>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="well">
        <p>Narrow by:</p>
        <form class="">
          <div class="row">
            <div class="col-sm-6 col-md-2">
              <label class="sr-only" for="input-year">Year</label>
              <select class="form-control selectpicker" id="input-year" name="year">
                <option value="0">All Years</option>
                {% for valid_year in valid_years %}
                  <option value="{{valid_year}}"{% if valid_year == year %} selected="selected"{% endif %}>{{valid_year}}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-sm-6 col-md-3">
              <label class="sr-only" for="input-award">Award Filter</label>
              <select class="form-control selectpicker" id="input-award-type" name="award_type" multiple title="Won Awards" data-actions-box="true" data-live-search="true">
                {% for valid_award_type, valid_award_type_name in valid_award_types %}
                  <option value="{{valid_award_type}}"{% if valid_award_type in award_types %} selected="selected"{% endif %}>{{valid_award_type_name}}</option>
                  {% if loop.index == num_special_awards %}<option data-divider="true"></option>{% endif %}
                {% endfor %}
              </select>
            </div>

            <div class="col-sm-6 col-md-3">
              <label class="sr-only" for="input-event-type">Event Filter</label>
              <select class="form-control selectpicker" id="input-event-type" name="event_type" multiple title="At Events" data-actions-box="true" disabled>
                {% for valid_event_type, valid_event_type_name in valid_event_types %}
                  <option value="{{valid_event_type}}"{% if valid_event_type in event_types %} selected="selected"{% endif %}>{{valid_event_type_name}}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-sm-6 col-md-2">
              <label class="sr-only" for="input-location">Near Location</label>
              <input type="text" class="form-control" id="input-location" name="location" placeholder="City / Zip / Address"{% if location %} value="{{location}}"{% endif %}">
            </div>

            <div class="col-sm-12 col-md-2">
              <button type="submit" class="btn btn-success btn-block"><span class="glyphicon glyphicon-search"></span> Search</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-8 col-sm-offset-2">
      {% if results %}
        <p>{{num_results}} {% if search_type == 'teams' %}team{% else %}event{% endif %}{% if num_results != 1 %}s{% endif %} found</p>

        {% if num_results > page_size %}
          <nav aria-label="Page navigation">
            <ul class="pagination">
              {% if page != 0 %}
              <li>
                <a href="/nearby?year={{year}}{% for award_type in award_types %}&award_type={{award_type}}{% endfor %}{% for event_type in event_types %}&event_type={{event_type}}{% endfor %}&location={{location}}&page={{page - 1}}&search_type={{search_type}}" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              {% endif %}
              {% for i in range((num_results / page_size)|ceil) %}
                <li {% if i == page %}class="active"{% endif %}>
                  <a href="/nearby?year={{year}}{% for award_type in award_types %}&award_type={{award_type}}{% endfor %}{% for event_type in event_types %}&event_type={{event_type}}{% endfor %}&location={{location}}&page={{i}}&search_type={{search_type}}">
                    {{page_size * i + 1}}-
                    {%- if loop.last -%}
                      {{page_size * i + num_results - page_size * i}}
                    {%- else -%}
                      {{page_size * i + page_size}}
                    {% endif %}
                  </a>
                </li>
              {% endfor %}
              {% if page != (num_results / page_size)|ceil - 1 %}
              <li>
                <a href="/nearby?year={{year}}{% for award_type in award_types %}&award_type={{award_type}}{% endfor %}{% for event_type in event_types %}&event_type={{event_type}}{% endfor %}&location={{location}}&page={{page + 1}}&search_type={{search_type}}" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
              {% endif %}
            </ul>
          </nav>
        {% endif %}

        <table class="event-table">
          <thead>
            <tr>
              <th>{% if search_type == 'teams' %}Team{% else %}Event{% endif %}</th>
              {% if search_type == 'events' %}<th>Dates</th>{% endif %}
              {% for field_name in field_names %}
              <th>{{field_name}}</th>
              {% endfor %}
              {% if distances %}<th>Distance</th>{% endif %}
            </tr>
          </thead>
          <tbody>
            {% for result, fields in results %}
              <tr>
                <td>
                  {% if search_type == 'teams' %}
                    <a href="/team/{{result.team_number}}/{% if year == 0 %}history{% else %}{{year}}{% endif %}" title="Team {{result.team_number }} - {{result.nickname}}">Team {{result.team_number }} - {{result.nickname}}</a>
                  {% else %}
                    <a href="/event/{{result.key_name}}" title="{{result.name}}">{{result.name}}</a>
                  {% endif %}
                    {% if result.city_state_country %}
                      <br>
                      <small>{{result.city_state_country}}</small>
                    {% endif %}
                </td>
                {% if search_type == 'events' %}
                <td>
                  {% if result.start_date %}<time itemprop="startDate" datetime="{{result.start_date|strftime("%c")}}">{{ result.start_date|strftime("%b %d") }}{% if result.start_date.date() != result.end_date.date() %}</time> to <time itemprop="endDate" datetime="{{result.end_date|strftime("%c")}}">{{ result.end_date|strftime("%b %d") }}{% endif %}{{ result.end_date|strftime(", %Y") }}</time>{% endif %}
                </td>
                {% endif %}
                {% for returned_field in returned_fields %}
                  <td>{{fields.get(returned_field)|int}}</td>
                {% endfor %}
                {% if distances %}
                <td>
                  {{distances[result.key.id()]|round|int}} miles
                </td>
                {% endif %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="well">No {% if search_type == 'teams' %}teams{% else %}events {% endif %} were found matching the search criteria. Try choosing less restrictive filters.</p>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}

{% block inline_javascript %}
<script>
  $('#input-award-type').on('changed.bs.select loaded.bs.select', function () {
    if ($(this).selectpicker('val') == null) {
      $('#input-event-type').prop('disabled', true);
      $('#input-event-type').selectpicker('refresh');
    } else {
      $('#input-event-type').prop('disabled', false);
      $('#input-event-type').selectpicker('refresh');
    }
  });
</script>
{% endblock %}
